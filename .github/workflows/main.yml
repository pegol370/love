name: Build APK
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04  # استخدام إصدار أقدم أكثر استقراراً
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Python 3.8
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'  # إصدار أكثر توافقاً مع buildozer
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            python3 \
            python3-dev \
            python3-pip \
            python3-setuptools \
            python3-wheel \
            python3-venv \
            openjdk-8-jdk \
            zip \
            unzip \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo5 \
            cmake \
            libffi-dev \
            libssl-dev \
            autoconf \
            libtool \
            pkg-config
            
      - name: Set JAVA_HOME
        run: |
          echo "JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64" >> $GITHUB_ENV
          echo "PATH=/usr/lib/jvm/java-8-openjdk-amd64/bin:$PATH" >> $GITHUB_ENV
          
      - name: Install Python packages
        run: |
          python3 -m pip install --upgrade pip
          pip3 install cython==0.29.33
          pip3 install buildozer
          
      - name: Create buildozer.spec
        run: |
          buildozer init
          # تحديث buildozer.spec
          sed -i 's/title = My Application/title = LoveMum/' buildozer.spec
          sed -i 's/package.name = myapp/package.name = lovemum/' buildozer.spec  
          sed -i 's/package.domain = org.example/package.domain = org.pegol/' buildozer.spec
          sed -i 's/source.dir = ./source.dir = ./' buildozer.spec
          sed -i 's/version = 0.1/version = 1.0/' buildozer.spec
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy/' buildozer.spec
          sed -i 's/#android.permissions = INTERNET/android.permissions = INTERNET/' buildozer.spec
          sed -i 's/#android.api = 31/android.api = 30/' buildozer.spec
          sed -i 's/#android.minapi = 21/android.minapi = 21/' buildozer.spec
          sed -i 's/#android.sdk = 31/android.sdk = 30/' buildozer.spec
          sed -i 's/#android.ndk = 25b/android.ndk = 23b/' buildozer.spec
          sed -i 's/#android.build_tools = 31.0.0/android.build_tools = 30.0.3/' buildozer.spec
          sed -i 's/#android.accept_sdk_license = False/android.accept_sdk_license = True/' buildozer.spec
          sed -i 's/#android.arch = arm64-v8a/android.arch = arm64-v8a/' buildozer.spec
          echo "android.gradle_dependencies = " >> buildozer.spec
          
      - name: Show buildozer.spec content
        run: |
          echo "=== buildozer.spec content ==="
          cat buildozer.spec
          echo "=========================="
          
      - name: Cache buildozer global directory
        uses: actions/cache@v3
        with:
          path: ~/.buildozer
          key: buildozer-${{ hashFiles('buildozer.spec') }}
          
      - name: Build APK
        run: |
          # متغيرات البيئة
          export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
          export ANDROID_HOME="$HOME/.buildozer/android/platform/android-sdk"
          export PATH="$ANDROID_SDK_ROOT/tools/bin:$PATH"
          
          # تشغيل buildozer
          buildozer -v android debug
          
      - name: Find APK files
        run: |
          echo "Searching for APK files..."
          find . -name "*.apk" -type f
          ls -la bin/ 2>/dev/null || echo "No bin directory found"
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: LoveMum-APK
          path: |
            bin/*.apk
            **/*.apk
