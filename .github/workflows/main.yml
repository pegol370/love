name: Build APK - Proven Working
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git zip unzip wget \
            python3-dev zlib1g-dev libncurses5-dev \
            libffi-dev libssl-dev autoconf libtool cmake
            
      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          pip install kivy cython
          # استخدام إصدار قديم من buildozer يعمل
          pip install buildozer==1.2.0
          
      - name: Create minimal buildozer.spec
        run: |
          # إنشاء buildozer.spec مُبسط
          cat > buildozer.spec << 'EOF'
          [app]
          title = LoveMum
          package.name = lovemum
          package.domain = org.pegol
          source.dir = .
          source.include_exts = py,png,jpg,kv,atlas
          version = 1.0
          requirements = python3,kivy
          orientation = portrait
          
          [buildozer]
          log_level = 2
          
          [android]
          android.api = 28
          android.minapi = 21
          android.sdk = 28
          android.ndk = 19b
          android.build_tools = 28.0.3
          android.accept_sdk_license = True
          android.arch = armeabi-v7a
          android.permissions = INTERNET
          EOF
          
      - name: Show current directory and files
        run: |
          echo "=== الملفات الموجودة ==="
          ls -la
          echo "=== محتوى main.py ==="
          head -20 main.py
          
      - name: Cache Buildozer global directory
        uses: actions/cache@v3
        with:
          path: .buildozer_global
          key: buildozer-global-${{ hashFiles('buildozer.spec') }}
          
      - name: Cache Buildozer directory
        uses: actions/cache@v3
        with:
          path: .buildozer
          key: buildozer-${{ hashFiles('buildozer.spec') }}
          
      - name: Build APK
        run: |
          # تشغيل buildozer مع timeout
          timeout 1800 buildozer android debug || {
            echo "Build failed or timed out"
            echo "=== Checking what was created ==="
            find . -name "*.apk" -type f 2>/dev/null || echo "No APK found"
            exit 1
          }
          
      - name: Find generated APK
        run: |
          echo "=== البحث عن APK في جميع المجلدات ==="
          find . -name "*.apk" -type f -exec ls -la {} \; 2>/dev/null || echo "No APK files found"
          
          echo "=== محتويات bin ==="
          ls -la bin/ 2>/dev/null || echo "No bin directory"
          
          echo "=== محتويات .buildozer ==="
          find .buildozer -name "*.apk" -type f 2>/dev/null | head -5 || echo "No APK in .buildozer"
          
      - name: Create APK directory and copy
        run: |
          mkdir -p apk-output
          
          # البحث عن أي APK وجد
          APK_COUNT=$(find . -name "*.apk" -type f 2>/dev/null | wc -l)
          echo "Found $APK_COUNT APK files"
          
          if [ $APK_COUNT -gt 0 ]; then
            # نسخ أول APK وجد
            FIRST_APK=$(find . -name "*.apk" -type f 2>/dev/null | head -1)
            cp "$FIRST_APK" apk-output/LoveMum.apk
            echo "تم نسخ APK: $FIRST_APK"
            ls -la apk-output/
          else
            # إنشاء APK وهمي للاختبار
            echo "لم يُعثر على APK - إنشاء ملف اختبار"
            echo "This is a test file - build failed" > apk-output/build-failed.txt
            
            # عرض آخر سجلات للتشخيص
            echo "=== آخر أخطاء البناء ==="
            find . -name "*.log" -type f -exec tail -20 {} \; 2>/dev/null || echo "No log files"
          fi
          
      - name: Upload APK or error info
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: LoveMum-Build-Result
          path: apk-output/
          retention-days: 5
